{% extends "base.html" %}

{% block title %}AgroScan - Detector de Enfermedades{% endblock %}

{% block active_page %}dashboard{% endblock %}

{% block page_title %}Hola, AgroScan üå±{% endblock %}
{% block page_subtitle %}Bienvenido a tu panel de control{% endblock %}

{% block header_actions %}
<div class="flex items-center gap-3">
    <div class="relative">
        <input type="text" placeholder="Buscar..." class="w-64 pl-10 pr-4 py-2 bg-slate-100 dark:bg-slate-800 text-slate-800 dark:text-white rounded-xl text-sm border border-slate-200 dark:border-slate-700 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 placeholder-slate-400 dark:placeholder-slate-500">
        <svg class="w-4 h-4 text-slate-400 dark:text-slate-500 absolute left-3 top-1/2 transform -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
        </svg>
    </div>
    
    <div class="flex items-center gap-2">
        <a href="/dashboard" class="px-4 py-2 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 rounded-xl text-sm font-medium hover:bg-slate-200 dark:hover:bg-slate-700 transition">
            Vista General
        </a>
        
        <a href="/dashboard" class="px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl text-sm font-medium shadow-lg shadow-blue-500/30">
            Dashboard
        </a>
    </div>
</div>
{{ super() }}
{% endblock %}

{% block content %}
                <!-- Decorative Elements -->
                <div class="relative">
                    <div class="absolute top-20 right-10 w-32 h-32 bg-emerald-400/20 dark:bg-emerald-400/10 rounded-full blur-3xl"></div>
                    <div class="absolute bottom-40 left-10 w-40 h-40 bg-blue-400/20 dark:bg-blue-400/10 rounded-full blur-3xl"></div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 relative z-10">
                        <!-- Left Column -->
                        <div class="lg:col-span-2 space-y-6">
                            <!-- Stats Cards -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Tasks Card -->
                                <div class="bg-white/80 dark:bg-slate-900/80 backdrop-blur-xl rounded-3xl p-6 border border-slate-200/60 dark:border-slate-700/60 shadow-xl shadow-slate-200/50 dark:shadow-slate-900/50">
                                    <div class="flex items-start justify-between mb-4">
                                        <div>
                                            <div class="flex items-center gap-2 mb-2">
                                                <div class="w-8 h-8 bg-emerald-100 dark:bg-emerald-900/30 rounded-lg flex items-center justify-center">
                                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                                                    </svg>
                                                </div>
                                                <span class="text-slate-800 dark:text-white font-bold text-lg">An√°lisis</span>
                                            </div>
                                            <p id="weekScanText" class="text-slate-600 dark:text-slate-400 text-sm">Has realizado 0 escaneos esta semana </p>
                                        </div>
                                        <div class="relative w-24 h-24">
                                            <svg class="w-full h-full transform -rotate-90" viewBox="0 0 100 100">
                                                <circle cx="50" cy="50" r="40" stroke="rgba(59, 130, 246, 0.1)" stroke-width="8" fill="none"/>
                                                <circle id="progressCircle" cx="50" cy="50" r="40" stroke="url(#gradient)" stroke-width="8" fill="none" stroke-dasharray="251.2" stroke-dashoffset="251.2" stroke-linecap="round"/>
                                                <defs>
                                                    <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                                        <stop offset="0%" style="stop-color:#3B82F6;stop-opacity:1" />
                                                        <stop offset="100%" style="stop-color:#8B5CF6;stop-opacity:1" />
                                                    </linearGradient>
                                                </defs>
                                            </svg>
                                            <div class="absolute inset-0 flex items-center justify-center">
                                                <svg class="w-8 h-8 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                                                </svg>
                                            </div>
                                        </div>
                                    </div>
                                    <button onclick="window.location.href='/camera'" class="w-full py-3 bg-gradient-to-r from-emerald-500 to-emerald-600 text-white rounded-2xl font-medium shadow-lg shadow-emerald-500/30 hover:shadow-xl transition">
                                        Nuevo Escaneo
                                    </button>
                                </div>

                                <!-- Quick Stats -->
                                <div class="bg-white/80 dark:bg-slate-900/80 backdrop-blur-xl rounded-3xl p-6 border border-slate-200/60 dark:border-slate-700/60 shadow-xl shadow-slate-200/50 dark:shadow-slate-900/50">
                                    <h3 class="text-slate-600 dark:text-slate-400 text-sm mb-4">Estad√≠sticas R√°pidas</h3>
                                    <div class="space-y-4">
                                        <div class="flex items-center justify-between">
                                            <div id="totalScans" class="text-slate-800 dark:text-white font-bold text-2xl">0</div>
                                            <div class="text-slate-600 dark:text-slate-400 text-sm">Escaneos Totales</div>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <div id="avgPrecision" class="text-emerald-600 dark:text-emerald-400 font-bold text-2xl">0%</div>
                                            <div class="text-slate-600 dark:text-slate-400 text-sm">Precisi√≥n</div>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <div id="thisWeekScans" class="text-blue-600 dark:text-blue-400 font-bold text-2xl">0</div>
                                            <div class="text-slate-600 dark:text-slate-400 text-sm">Esta Semana</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Chart Card -->
                            <div class="bg-white/80 dark:bg-slate-900/80 backdrop-blur-xl rounded-3xl p-6 border border-slate-200/60 dark:border-slate-700/60 shadow-xl shadow-slate-200/50 dark:shadow-slate-900/50">
                                <div class="flex items-center justify-between mb-6">
                                    <div>
                                        <h3 class="text-slate-800 dark:text-white font-bold text-lg">An√°lisis Completados</h3>
                                        <p class="text-slate-600 dark:text-slate-400 text-sm mt-1">√öltimos 7 d√≠as</p>
                                    </div>
                                </div>
                                <div id="chartContainer" class="w-full" style="height: 250px;">
                                    <!-- Highcharts line chart generado por JavaScript -->
                                </div>
                            </div>

                            <!-- Disease Distribution Card -->
                            <div class="bg-white/80 dark:bg-slate-900/80 backdrop-blur-xl rounded-3xl p-6 border border-slate-200/60 dark:border-slate-700/60 shadow-xl shadow-slate-200/50 dark:shadow-slate-900/50">
                                <div class="flex items-center justify-between mb-6">
                                    <div>
                                        <h3 class="text-slate-800 dark:text-white font-bold text-lg">Distribuci√≥n de Enfermedades</h3>
                                        <p class="text-slate-600 dark:text-slate-400 text-sm mt-1">An√°lisis detectados por tipo</p>
                                    </div>
                                    <div class="text-right">
                                        <div id="totalAnalysisCount" class="text-2xl font-bold text-slate-800 dark:text-white">0</div>
                                        <div class="text-xs text-slate-500 dark:text-slate-400">Total</div>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                    <!-- Pie Chart -->
                                    <div class="flex items-center justify-center p-4">
                                        <div class="relative w-full" style="height: 300px;">
                                            <!-- Fondo decorativo -->
                                            <div class="absolute inset-0 bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-800/30 dark:to-slate-900/30 rounded-full blur-2xl opacity-50"></div>
                                            
                                            <!-- Highcharts Container -->
                                            <div id="pieChart" class="relative z-10 w-full h-full"></div>
                                        </div>
                                    </div>
                                    
                                    <!-- Legend -->
                                    <div id="diseaseLegend" class="space-y-2 flex flex-col justify-center">
                                        <!-- La leyenda se generar√° con JavaScript -->
                                    </div>
                                </div>
                            </div>
                            
                        </div>

                        <!-- Right Column -->
                        <div class="space-y-6">
                            <!-- Diseases Card -->
                            <div class="bg-white/80 dark:bg-slate-900/80 backdrop-blur-xl rounded-3xl p-6 border border-slate-200/60 dark:border-slate-700/60 shadow-xl shadow-slate-200/50 dark:shadow-slate-900/50">
                                <div class="flex items-center justify-between mb-6">
                                    <h3 class="text-slate-800 dark:text-white font-bold text-lg">Enfermedades Detectables</h3>
                                </div>
                                <div class="space-y-3">
                                    <!-- Primera fila: 2 columnas -->
                                    <div class="grid grid-cols-2 gap-3">
                                        <div class="bg-gradient-to-br from-emerald-50 to-emerald-100/50 dark:from-emerald-900/30 dark:to-emerald-800/20 rounded-2xl p-4 border border-emerald-200 dark:border-emerald-700 hover:border-emerald-300 dark:hover:border-emerald-600 transition cursor-pointer shadow-sm h-[120px]">
                                            <div class="flex flex-col items-center text-center gap-2 h-full justify-center">
                                                <div class="w-10 h-10 bg-emerald-500/20 dark:bg-emerald-500/30 rounded-xl flex items-center justify-center">
                                                    <svg class="w-5 h-5 text-emerald-600 dark:text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                                    </svg>
                                                </div>
                                                <div>
                                                    <div class="text-slate-800 dark:text-white font-semibold text-sm">Saludable</div>
                                                    <div class="text-emerald-600 dark:text-emerald-400 text-xs mt-1">98% precisi√≥n</div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="bg-gradient-to-br from-orange-50 to-orange-100/50 dark:from-orange-900/30 dark:to-orange-800/20 rounded-2xl p-4 border border-orange-200 dark:border-orange-700 hover:border-orange-300 dark:hover:border-orange-600 transition cursor-pointer shadow-sm h-[120px]">
                                            <div class="flex flex-col items-center text-center gap-2 h-full justify-center">
                                                <div class="w-10 h-10 bg-orange-500/20 dark:bg-orange-500/30 rounded-xl flex items-center justify-center">
                                                    <svg class="w-5 h-5 text-orange-600 dark:text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                                    </svg>
                                                </div>
                                                <div>
                                                    <div class="text-slate-800 dark:text-white font-semibold text-sm">Mosaico</div>
                                                    <div class="text-orange-600 dark:text-orange-400 text-xs mt-1">95% precisi√≥n</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Segunda fila: 2 columnas -->
                                    <div class="grid grid-cols-2 gap-3">
                                        <div class="bg-gradient-to-br from-red-50 to-red-100/50 dark:from-red-900/30 dark:to-red-800/20 rounded-2xl p-4 border border-red-200 dark:border-red-700 hover:border-red-300 dark:hover:border-red-600 transition cursor-pointer shadow-sm h-[120px]">
                                            <div class="flex flex-col items-center text-center gap-2 h-full justify-center">
                                                <div class="w-10 h-10 bg-red-500/20 dark:bg-red-500/30 rounded-xl flex items-center justify-center">
                                                    <svg class="w-5 h-5 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                                    </svg>
                                                </div>
                                                <div>
                                                    <div class="text-slate-800 dark:text-white font-semibold text-sm">Podredumbre</div>
                                                    <div class="text-red-600 dark:text-red-400 text-xs mt-1">96% precisi√≥n</div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="bg-gradient-to-br from-amber-50 to-amber-100/50 dark:from-amber-900/30 dark:to-amber-800/20 rounded-2xl p-4 border border-amber-200 dark:border-amber-700 hover:border-amber-300 dark:hover:border-amber-600 transition cursor-pointer shadow-sm h-[120px]">
                                            <div class="flex flex-col items-center text-center gap-2 h-full justify-center">
                                                <div class="w-10 h-10 bg-amber-500/20 dark:bg-amber-500/30 rounded-xl flex items-center justify-center">
                                                    <svg class="w-5 h-5 text-amber-600 dark:text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                                    </svg>
                                                </div>
                                                <div>
                                                    <div class="text-slate-800 dark:text-white font-semibold text-sm">Roya</div>
                                                    <div class="text-amber-600 dark:text-amber-400 text-xs mt-1">94% precisi√≥n</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Tercera fila: 1 columna que ocupa todo el ancho -->
                                    <div class="bg-gradient-to-br from-yellow-50 to-yellow-100/50 dark:from-yellow-900/30 dark:to-yellow-800/20 rounded-2xl p-4 border border-yellow-200 dark:border-yellow-700 hover:border-yellow-300 dark:hover:border-yellow-600 transition cursor-pointer shadow-sm h-[120px]">
                                        <div class="flex flex-col items-center text-center gap-2 h-full justify-center">
                                            <div class="w-10 h-10 bg-yellow-500/20 dark:bg-yellow-500/30 rounded-xl flex items-center justify-center">
                                                <svg class="w-5 h-5 text-yellow-600 dark:text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                                </svg>
                                            </div>
                                            <div>
                                                <div class="text-slate-800 dark:text-white font-semibold text-sm">Amarillamiento</div>
                                                <div class="text-yellow-600 dark:text-yellow-400 text-xs mt-1">93% precisi√≥n</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Recent Activity -->
                            <div class="bg-white/80 dark:bg-slate-900/80 backdrop-blur-xl rounded-3xl p-6 border border-slate-200/60 dark:border-slate-700/60 shadow-xl shadow-slate-200/50 dark:shadow-slate-900/50">
                                <div class="flex items-center justify-between mb-6">
                                    <h3 class="text-slate-800 dark:text-white font-bold text-lg">Actividad Reciente</h3>
                                    <button onclick="window.location.href='/history'" class="text-blue-500 dark:text-blue-400 text-sm font-medium hover:text-blue-600 dark:hover:text-blue-300">Ver todo</button>
                                </div>
                                <div id="recentActivityContainer" class="space-y-4">
                                    <!-- Contenido din√°mico cargado por JavaScript -->
                                    <div class="text-center py-8 text-slate-500 dark:text-slate-400">
                                        <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                                        </svg>
                                        <p class="text-sm">No hay an√°lisis recientes</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Funci√≥n para obtener el inicio de la semana actual (Lunes)
    const getWeekStart = () => {
        const now = new Date();
        const dayOfWeek = now.getDay();
        const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek; // Si es domingo, retrocede 6 d√≠as
        const monday = new Date(now);
        monday.setDate(now.getDate() + diff);
        monday.setHours(0, 0, 0, 0);
        return monday;
    };

    // Funci√≥n para obtener el nombre del d√≠a en espa√±ol
    const getDayName = (date) => {
        const days = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
        return days[date.getDay()];
    };

    // Funci√≥n para parsear fecha del historial
    const parseHistoryDate = (dateStr, timeStr) => {
        try {
            // Si dateStr ya es una fecha ISO o contiene guiones/barras
            if (dateStr && timeStr) {
                // Intenta parsear directamente
                const combined = `${dateStr} ${timeStr}`;
                const parsed = new Date(combined);
                
                // Si es v√°lida, retorna
                if (!isNaN(parsed.getTime())) {
                    return parsed;
                }
                
                // Intenta formato alternativo DD/MM/YYYY o similar
                const parts = dateStr.split(/[\/\-\.]/);
                if (parts.length === 3) {
                    // Asume DD/MM/YYYY o MM/DD/YYYY
                    const timeParts = timeStr.split(':');
                    const date = new Date(parts[2], parts[1] - 1, parts[0], 
                                         timeParts[0] || 0, timeParts[1] || 0, timeParts[2] || 0);
                    if (!isNaN(date.getTime())) {
                        return date;
                    }
                }
            }
            return null;
        } catch (e) {
            console.error('Error parseando fecha:', dateStr, timeStr, e);
            return null;
        }
    };

    // Funci√≥n para calcular estad√≠sticas de la semana
    const calculateWeeklyStats = () => {
        const history = JSON.parse(localStorage.getItem('prediction_history') || '[]');
        const weekStart = getWeekStart();
        const now = new Date();
        
        // Filtrar escaneos de esta semana
        const weekScans = history.filter(item => {
            const itemDate = parseHistoryDate(item.date, item.time);
            return itemDate && itemDate >= weekStart && itemDate <= now;
        });

        // Calcular d√≠as desde el inicio de la semana
        const daysSinceMonday = Math.floor((now - weekStart) / (1000 * 60 * 60 * 24));
        const expectedScans = (daysSinceMonday + 1) * 2; // Meta: 2 escaneos por d√≠a
        
        return {
            weekCount: weekScans.length,
            expectedCount: expectedScans,
            totalCount: history.length,
            avgConfidence: history.length > 0 
                ? (history.reduce((sum, item) => sum + (item.confidence || 0), 0) / history.length * 100).toFixed(0)
                : 0
        };
    };

    // Funci√≥n para actualizar el contador semanal
    const updateWeeklyCounter = () => {
        const stats = calculateWeeklyStats();
        
        console.log('üìä Estad√≠sticas calculadas:', stats);
        
        // Actualizar textos
        const weekCountEl = document.getElementById('weekCountText');
        const weekScanEl = document.getElementById('weekScanText');
        const progressCircleEl = document.getElementById('progressCircle');
        
        if (weekCountEl) weekCountEl.textContent = `${stats.weekCount}/${stats.expectedCount}`;
        if (weekScanEl) weekScanEl.textContent = `Has realizado ${stats.weekCount} escaneo${stats.weekCount !== 1 ? 's' : ''} esta semana`;
        
        // Actualizar c√≠rculo de progreso
        const percentage = stats.expectedCount > 0 ? (stats.weekCount / stats.expectedCount) : 0;
        const circumference = 251.2;
        const offset = circumference - (percentage * circumference);
        if (progressCircleEl) progressCircleEl.style.strokeDashoffset = offset;
        
        // Actualizar estad√≠sticas r√°pidas
        const totalScansEl = document.getElementById('totalScans');
        const avgPrecisionEl = document.getElementById('avgPrecision');
        const thisWeekScansEl = document.getElementById('thisWeekScans');
        
        if (totalScansEl) totalScansEl.textContent = stats.totalCount;
        if (avgPrecisionEl) avgPrecisionEl.textContent = `${stats.avgConfidence}%`;
        if (thisWeekScansEl) thisWeekScansEl.textContent = stats.weekCount;
    };

    // Variable global para almacenar la instancia del gr√°fico de l√≠nea
    let lineChartInstance = null;

    // Funci√≥n para generar el gr√°fico de l√≠nea con Highcharts
    const generateWeekChart = () => {
        const history = JSON.parse(localStorage.getItem('prediction_history') || '[]');
        const chartContainer = document.getElementById('chartContainer');
        const now = new Date();
        
        if (!chartContainer) return;
        
        // Crear array de los √∫ltimos 7 d√≠as
        const last7Days = [];
        const dayLabels = [];
        for (let i = 6; i >= 0; i--) {
            const date = new Date(now);
            date.setDate(now.getDate() - i);
            date.setHours(0, 0, 0, 0);
            last7Days.push(date);
            dayLabels.push(getDayName(date));
        }
        
        // Contar escaneos por d√≠a
        const dayCounts = last7Days.map(day => {
            const nextDay = new Date(day);
            nextDay.setDate(day.getDate() + 1);
            
            const count = history.filter(item => {
                const itemDate = parseHistoryDate(item.date, item.time);
                return itemDate && itemDate >= day && itemDate < nextDay;
            }).length;
            
            return count;
        });
        
        // Detectar modo oscuro
        const isDark = document.documentElement.classList.contains('dark');
        
        // Crear gr√°fico con Highcharts
        lineChartInstance = Highcharts.chart('chartContainer', {
            chart: {
                type: 'line',
                backgroundColor: 'transparent',
                height: 250,
                spacing: [10, 10, 10, 10]
            },
            title: {
                text: null
            },
            subtitle: {
                text: null
            },
            xAxis: {
                categories: dayLabels,
                lineColor: isDark ? '#334155' : '#e2e8f0',
                tickColor: isDark ? '#334155' : '#e2e8f0',
                labels: {
                    style: {
                        color: isDark ? '#94a3b8' : '#64748b',
                        fontSize: '12px'
                    }
                }
            },
            yAxis: {
                title: {
                    text: 'N√∫mero de Escaneos',
                    style: {
                        color: isDark ? '#94a3b8' : '#64748b',
                        fontSize: '12px'
                    }
                },
                gridLineColor: isDark ? '#1e293b' : '#f1f5f9',
                labels: {
                    style: {
                        color: isDark ? '#94a3b8' : '#64748b',
                        fontSize: '12px'
                    }
                },
                allowDecimals: false,
                min: 0
            },
            legend: {
                enabled: false
            },
            tooltip: {
                headerFormat: '<span style="font-size: 13px; font-weight: bold;">{point.key}</span><br/>',
                pointFormat: '<span style="color:{series.color}">‚óè</span> Escaneos: <b>{point.y}</b>',
                backgroundColor: isDark ? 'rgba(15, 23, 42, 0.95)' : 'rgba(255, 255, 255, 0.95)',
                borderColor: isDark ? 'rgba(148, 163, 184, 0.2)' : 'rgba(226, 232, 240, 0.8)',
                borderRadius: 8,
                style: {
                    color: isDark ? '#e2e8f0' : '#1e293b',
                    fontSize: '13px'
                }
            },
            plotOptions: {
                line: {
                    dataLabels: {
                        enabled: false
                    },
                    enableMouseTracking: true,
                    marker: {
                        enabled: true,
                        radius: 4,
                        fillColor: '#10b981',
                        lineWidth: 2,
                        lineColor: '#ffffff',
                        states: {
                            hover: {
                                enabled: true,
                                radius: 6,
                                lineWidth: 3
                            }
                        }
                    }
                },
                series: {
                    animation: {
                        duration: 1000
                    }
                }
            },
            series: [{
                name: 'Escaneos',
                data: dayCounts,
                color: '#10b981',
                lineWidth: 3,
                shadow: {
                    color: 'rgba(16, 185, 129, 0.3)',
                    width: 5,
                    offsetX: 0,
                    offsetY: 2
                }
            }],
            credits: {
                enabled: false
            },
            responsive: {
                rules: [{
                    condition: {
                        maxWidth: 500
                    },
                    chartOptions: {
                        chart: {
                            height: 200
                        },
                        xAxis: {
                            labels: {
                                style: {
                                    fontSize: '10px'
                                }
                            }
                        },
                        yAxis: {
                            title: {
                                text: null
                            },
                            labels: {
                                style: {
                                    fontSize: '10px'
                                }
                            }
                        }
                    }
                }]
            }
        });
    };

    // Variable global para almacenar la instancia del gr√°fico
    let pieChartInstance = null;

    // Funci√≥n para generar el gr√°fico de pastel con Highcharts
    const generatePieChart = () => {
        const history = JSON.parse(localStorage.getItem('prediction_history') || '[]');
        const container = document.getElementById('pieChart');
        const legend = document.getElementById('diseaseLegend');
        const totalAnalysis = document.getElementById('totalAnalysisCount');
        
        if (!container) return;
        
        if (!history || history.length === 0) {
            container.innerHTML = '';
            legend.innerHTML = '<div class="text-center text-slate-500 dark:text-slate-400 text-sm py-4">No hay datos disponibles</div>';
            if (totalAnalysis) totalAnalysis.textContent = '0';
            return;
        }
        
        // Contar enfermedades
        const diseaseCounts = {};
        history.forEach(item => {
            const disease = item.prediction || 'Unknown';
            diseaseCounts[disease] = (diseaseCounts[disease] || 0) + 1;
        });
        
        // Definir paleta de colores profesional con tonos vibrantes
        const diseaseColors = {
            'Healthy': { color: '#10b981', name: 'Saludable', icon: '‚Ä¢' },
            'Mosaic': { color: '#f59e0b', name: 'Mosaico', icon: '‚Ä¢' },
            'Rust': { color: '#fb923c', name: 'Roya', icon: '‚Ä¢' },
            'RedRot': { color: '#ef4444', name: 'Podredumbre', icon: '‚Ä¢' },
            'Yellow': { color: '#eab308', name: 'Amarillamiento', icon: '‚Ä¢' },
            'Unknown': { color: '#6366f1', name: 'Desconocido', icon: '‚Ä¢' }
        };
        
        // Convertir a array y ordenar por cantidad
        const diseaseArray = Object.entries(diseaseCounts)
            .map(([disease, count]) => ({
                disease,
                count,
                percentage: (count / history.length) * 100,
                ...diseaseColors[disease] || diseaseColors['Unknown']
            }))
            .sort((a, b) => b.count - a.count);
        
        // Actualizar total
        if (totalAnalysis) totalAnalysis.textContent = history.length;
        
        // Preparar datos para Highcharts
        const chartData = diseaseArray.map(item => ({
            name: item.name,
            y: item.count,
            z: item.percentage, // Usar porcentaje para el tama√±o variable
            color: item.color
        }));
        
        // Crear gr√°fico con Highcharts
        const isDark = document.documentElement.classList.contains('dark');
        
        pieChartInstance = Highcharts.chart('pieChart', {
            chart: {
                type: 'variablepie',
                backgroundColor: 'transparent',
                height: 300,
                spacing: [10, 10, 10, 10]
            },
            title: {
                text: null
            },
            tooltip: {
                headerFormat: '',
                pointFormat: '<span style="color:{point.color}">‚óè</span> <b>{point.name}</b><br/>' +
                    'Casos: <b>{point.y}</b><br/>' +
                    'Porcentaje: <b>{point.z:.1f}%</b><br/>',
                backgroundColor: isDark ? 'rgba(15, 23, 42, 0.95)' : 'rgba(255, 255, 255, 0.95)',
                borderColor: isDark ? 'rgba(148, 163, 184, 0.2)' : 'rgba(226, 232, 240, 0.8)',
                borderRadius: 8,
                style: {
                    color: isDark ? '#e2e8f0' : '#1e293b',
                    fontSize: '13px'
                }
            },
            plotOptions: {
                variablepie: {
                    dataLabels: {
                        enabled: false
                    },
                    borderRadius: 6,
                    borderWidth: 2,
                    borderColor: '#ffffff'
                }
            },
            series: [{
                minPointSize: 60,
                innerSize: '60%',
                zMin: 0,
                name: 'Enfermedades',
                data: chartData,
                states: {
                    hover: {
                        brightness: 0.1,
                        borderWidth: 3
                    }
                }
            }],
            credits: {
                enabled: false
            }
        });
        
        // Generar leyenda profesional y minimalista
        const legendHTML = diseaseArray.map((item, index) => `
            <div class="flex items-center justify-between p-3 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800/30 transition-all cursor-pointer group border border-transparent hover:border-slate-200 dark:hover:border-slate-700/50">
                <div class="flex items-center gap-3 flex-1">
                    <div class="w-3 h-3 rounded-sm flex-shrink-0 shadow-sm" style="background: ${item.color}"></div>
                    <div class="flex-1">
                        <div class="text-sm font-medium text-slate-700 dark:text-slate-300">${item.name}</div>
                        <div class="text-xs text-slate-500 dark:text-slate-500 font-normal mt-0.5">${item.percentage.toFixed(1)}%</div>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-lg font-semibold text-slate-800 dark:text-slate-200">${item.count}</div>
                    <div class="text-xs text-slate-500 dark:text-slate-500">caso${item.count !== 1 ? 's' : ''}</div>
                </div>
            </div>
        `).join('');
        
        legend.innerHTML = legendHTML;
    };

    // Funci√≥n para obtener el icono y colores seg√∫n la enfermedad
    const getDiseaseIcon = (disease) => {
        const icons = {
            'Healthy': { icon: 'M5 13l4 4L19 7', bgColor: 'bg-emerald-100 dark:bg-emerald-900/30', iconColor: 'text-emerald-600 dark:text-emerald-400' },
            'Mosaic': { icon: 'M12 9v2m0 4h.01', bgColor: 'bg-orange-100 dark:bg-orange-900/30', iconColor: 'text-orange-600 dark:text-orange-400' },
            'Rust': { icon: 'M12 9v2m0 4h.01', bgColor: 'bg-amber-100 dark:bg-amber-900/30', iconColor: 'text-amber-600 dark:text-amber-400' },
            'Mildew': { icon: 'M12 9v2m0 4h.01', bgColor: 'bg-purple-100 dark:bg-purple-900/30', iconColor: 'text-purple-600 dark:text-purple-400' },
            'Blight': { icon: 'M6 18L18 6M6 6l12 12', bgColor: 'bg-red-100 dark:bg-red-900/30', iconColor: 'text-red-600 dark:text-red-400' }
        };
        return icons[disease] || { icon: 'M12 9v2m0 4h.01', bgColor: 'bg-slate-100 dark:bg-slate-900/30', iconColor: 'text-slate-600 dark:text-slate-400' };
    };

    // Funci√≥n para calcular el tiempo relativo
    const getRelativeTime = (dateStr, timeStr) => {
        try {
            const itemDate = new Date(dateStr + ' ' + timeStr);
            const now = new Date();
            const diffMs = now - itemDate;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);

            if (diffMins < 1) return 'Hace un momento';
            if (diffMins < 60) return `Hace ${diffMins} minuto${diffMins > 1 ? 's' : ''}`;
            if (diffHours < 24) return `Hace ${diffHours} hora${diffHours > 1 ? 's' : ''}`;
            if (diffDays === 1) return 'Ayer';
            if (diffDays < 7) return `Hace ${diffDays} d√≠as`;
            return dateStr;
        } catch (e) {
            return dateStr;
        }
    };

    // Funci√≥n para cargar y mostrar los √∫ltimos 3 an√°lisis
    const loadRecentActivity = () => {
        const history = JSON.parse(localStorage.getItem('prediction_history') || '[]');
        const container = document.getElementById('recentActivityContainer');
        
        if (!history || history.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8 text-slate-500 dark:text-slate-400">
                    <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                    </svg>
                    <p class="text-sm">No hay an√°lisis recientes</p>
                    <a href="/camera" class="inline-block mt-3 text-blue-500 dark:text-blue-400 text-sm font-medium hover:text-blue-600 dark:hover:text-blue-300">Realizar primer escaneo</a>
                </div>
            `;
            return;
        }

        // Obtener los √∫ltimos 3 an√°lisis
        const recentItems = history.slice(0, 3);
        
        const html = recentItems.map(item => {
            const diseaseInfo = getDiseaseIcon(item.prediction);
            const relativeTime = getRelativeTime(item.date, item.time);
            
            return `
                <div class="flex items-start gap-3 p-3 rounded-xl bg-slate-50 dark:bg-slate-800/50 hover:bg-slate-100 dark:hover:bg-slate-800 transition cursor-pointer" onclick="window.location.href='/history'">
                    <div class="w-8 h-8 ${diseaseInfo.bgColor} rounded-lg flex items-center justify-center flex-shrink-0">
                        <svg class="w-4 h-4 ${diseaseInfo.iconColor}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${diseaseInfo.icon}"/>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <div class="text-sm font-medium text-slate-800 dark:text-white">${item.prediction}</div>
                        <div class="text-xs text-slate-500 dark:text-slate-400 mt-1">${relativeTime}</div>
                    </div>
                    <div class="text-xs font-semibold ${diseaseInfo.iconColor}">${(item.confidence * 100).toFixed(0)}%</div>
                </div>
            `;
        }).join('');
        
        container.innerHTML = html;
    };

    // Funci√≥n para actualizar todos los datos
    const updateDashboard = () => {
        console.log('üîÑ Actualizando dashboard...');
        const history = JSON.parse(localStorage.getItem('prediction_history') || '[]');
        console.log('üì¶ Historial cargado:', history.length, 'items');
        
        updateWeeklyCounter();
        generateWeekChart();
        generatePieChart();
        loadRecentActivity();
    };

    // Cargar dashboard al cargar la p√°gina
    document.addEventListener('DOMContentLoaded', () => {
        console.log('‚úÖ DOM cargado, inicializando dashboard...');
        updateDashboard();
    });
    
    // Recargar cada 30 segundos
    setInterval(updateDashboard, 30000);
</script>
{% endblock %}