{% extends "base.html" %}

{% block title %}AgroScan - Historial{% endblock %}

{% block active_page %}history{% endblock %}

{% block page_title %}Historial{% endblock %}
{% block page_subtitle %}Revisa todas tus predicciones{% endblock %}

{% block header_actions %}
<div class="flex items-center gap-3">
    <div class="relative">
        <input type="text" placeholder="Buscar..." class="w-64 pl-10 pr-4 py-2 bg-slate-100 dark:bg-slate-800 text-slate-800 dark:text-white rounded-xl text-sm border border-slate-200 dark:border-slate-700 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 placeholder-slate-400 dark:placeholder-slate-500">
        <svg class="w-4 h-4 text-slate-400 dark:text-slate-500 absolute left-3 top-1/2 transform -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
        </svg>
    </div>
    
    <div class="flex items-center gap-2">
        <a href="/dashboard" class="px-4 py-2 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 rounded-xl text-sm font-medium hover:bg-slate-200 dark:hover:bg-slate-700 transition">
            Dashboard
        </a>
        
        <a href="/history" class="px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl text-sm font-medium shadow-lg shadow-blue-500/30">
            Historial
        </a>
    </div>
</div>
{{ super() }}
{% endblock %}

{% block content %}
                <!-- Decorative Elements -->
                <div class="relative">
                    <div class="absolute top-20 right-10 w-32 h-32 bg-emerald-400/20 dark:bg-emerald-400/10 rounded-full blur-3xl"></div>
                    <div class="absolute bottom-40 left-10 w-40 h-40 bg-blue-400/20 dark:bg-blue-400/10 rounded-full blur-3xl"></div>
                    
                    <div class="max-w-7xl mx-auto px-6 py-8 relative z-10">
                        <!-- Header Section -->
                        <div class="mb-8">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h1 class="text-3xl font-bold text-slate-800 dark:text-white mb-2">Historial de An√°lisis</h1>
                                    <p class="text-slate-600 dark:text-slate-400">Revisa todos tus escaneos y predicciones anteriores</p>
                                </div>
                                <div class="flex items-center gap-3">
                                    <button id="refreshBtn" class="px-4 py-2 bg-white/80 dark:bg-slate-900/80 backdrop-blur-xl text-slate-600 dark:text-slate-300 rounded-2xl border border-slate-200/60 dark:border-slate-700/60 hover:bg-slate-50/90 dark:hover:bg-slate-800/90 transition shadow-lg shadow-slate-200/50 dark:shadow-slate-900/50 flex items-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                        </svg>
                                        Actualizar
                                    </button>
                                    <button id="clearBtn" class="px-4 py-2 bg-red-50/80 dark:bg-red-900/30 backdrop-blur-xl text-red-600 dark:text-red-400 rounded-2xl border border-red-200/60 dark:border-red-800/60 hover:bg-red-100/90 dark:hover:bg-red-900/40 transition shadow-lg shadow-red-200/50 dark:shadow-red-900/50 flex items-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                        </svg>
                                        Limpiar Historial
                                    </button>
                                    <a href="/camera" class="px-4 py-2 bg-gradient-to-r from-emerald-500 to-emerald-600 text-white rounded-2xl shadow-xl shadow-emerald-500/30 hover:shadow-2xl transition flex items-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                        </svg>
                                        Nuevo An√°lisis
                                    </a>
                                </div>
                            </div>
                        </div>

                        <!-- Stats Cards -->
                        <div id="statsContainer" class="mb-8"></div>

                        <!-- Filters Section -->
                        <div class="bg-white/80 dark:bg-slate-900/80 backdrop-blur-xl rounded-3xl p-6 border border-slate-200/60 dark:border-slate-700/60 shadow-xl shadow-slate-200/50 dark:shadow-slate-900/50 mb-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold text-slate-800 dark:text-white">Filtros</h3>
                                <button id="resetFilters" class="text-sm text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 transition">Limpiar filtros</button>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Buscar</label>
                                    <input type="text" id="searchInput" placeholder="Buscar por enfermedad..." class="w-full px-3 py-2 bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm border border-slate-300/60 dark:border-slate-600/60 rounded-xl text-slate-900 dark:text-white placeholder:text-slate-500 focus:ring-2 focus:ring-emerald-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Tipo de enfermedad</label>
                                    <select id="diseaseFilter" class="w-full px-3 py-2 bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm border border-slate-300/60 dark:border-slate-600/60 rounded-xl text-slate-900 dark:text-white focus:ring-2 focus:ring-emerald-500 focus:border-transparent">
                                        <option value="">Todas</option>
                                        <option value="Healthy">Saludable</option>
                                        <option value="Mosaic">Mosaico</option>
                                        <option value="Rust">Roya</option>
                                        <option value="Mildew">Mildi√∫</option>
                                        <option value="Blight">Tiz√≥n</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Confianza m√≠nima</label>
                                    <select id="confidenceFilter" class="w-full px-3 py-2 bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm border border-slate-300/60 dark:border-slate-600/60 rounded-xl text-slate-900 dark:text-white focus:ring-2 focus:ring-emerald-500 focus:border-transparent">
                                        <option value="0">Todas</option>
                                        <option value="0.5">50%+</option>
                                        <option value="0.7">70%+</option>
                                        <option value="0.9">90%+</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Ordenar por</label>
                                    <select id="sortFilter" class="w-full px-3 py-2 bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm border border-slate-300/60 dark:border-slate-600/60 rounded-xl text-slate-900 dark:text-white focus:ring-2 focus:ring-emerald-500 focus:border-transparent">
                                        <option value="date-desc">M√°s recientes</option>
                                        <option value="date-asc">M√°s antiguos</option>
                                        <option value="confidence-desc">Mayor confianza</option>
                                        <option value="confidence-asc">Menor confianza</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Results Grid -->
                        <div id="listContainer"></div>
                    </div>
                </div>

<!-- Confirm Delete Modal -->
<div id="confirmDeleteModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50 p-4">
    <div class="bg-white/90 dark:bg-slate-900/90 backdrop-blur-2xl rounded-3xl p-8 max-w-md w-full shadow-2xl border border-slate-200/60 dark:border-slate-700/60">
        <div class="text-center mb-6">
            <div class="w-16 h-16 bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                </svg>
            </div>
            <h3 class="text-2xl font-bold text-slate-800 dark:text-white mb-2">¬øLimpiar Historial?</h3>
            <p class="text-slate-600 dark:text-slate-400">Esta acci√≥n eliminar√° todos los an√°lisis registrados y no se puede deshacer.</p>
        </div>
        <div class="flex gap-3">
            <button id="cancelDelete" class="flex-1 px-4 py-3 bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 rounded-2xl font-semibold hover:bg-slate-200 dark:hover:bg-slate-700 transition">
                Cancelar
            </button>
            <button id="confirmDelete" class="flex-1 px-4 py-3 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-2xl font-semibold shadow-lg shadow-red-500/30 hover:shadow-xl transition">
                Eliminar Todo
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
    <script>
        // Disease config
        const getDiseaseEmoji = (disease) => {
            const emojis = { 'Healthy': '‚úÖ', 'Mosaic': 'ü¶†', 'Rust': 'üçÇ', 'Mildew': '‚òÅÔ∏è', 'Blight': 'üíÄ', 'Unknown': '‚ùì' };
            return emojis[disease] || 'üåø';
        };

        const getDiseaseColor = (disease) => {
            const colors = { 'Healthy': 'rgb(34,197,94)', 'Mosaic': 'rgb(234,179,8)', 'Rust': 'rgb(249,115,22)', 'Mildew': 'rgb(168,85,247)', 'Blight': 'rgb(239,68,68)', 'Unknown': 'rgb(100,116,139)' };
            return colors[disease] || 'rgb(100,116,139)';
        };

        // Data management
        const loadHistory = () => {
            // Priorizar analysis_history como fuente principal
            const analysisHistory = JSON.parse(localStorage.getItem('analysis_history') || '[]');
            const predictionHistory = JSON.parse(localStorage.getItem('prediction_history') || '[]');
            
            console.log('Cargando historiales:');
            console.log('- analysis_history:', analysisHistory.length, 'elementos');
            console.log('- prediction_history:', predictionHistory.length, 'elementos');
            
            // Usar solo analysis_history si tiene datos, sino usar prediction_history como fallback
            let allHistory = analysisHistory.length > 0 ? analysisHistory : predictionHistory;
            
            // Normalizar los datos para asegurar consistencia
            allHistory = allHistory.map(item => {
                // Asegurar que tenga las propiedades necesarias
                return {
                    id: item.id || Date.now() + Math.random(),
                    imageUri: item.imageUri,
                    // Mapear diferentes formatos de predicci√≥n
                    prediction: item.prediction || (item.predictions && item.predictions[0] ? item.predictions[0].disease : 'Unknown'),
                    // Mapear diferentes formatos de confianza
                    confidence: item.confidence || (item.predictions && item.predictions[0] ? item.predictions[0].confidence : 0),
                    date: item.date || new Date().toLocaleDateString(),
                    time: item.time || new Date().toLocaleTimeString(),
                    usedTTA: item.usedTTA || false,
                    processingTime: item.processingTime || null,
                    timestamp: item.timestamp || new Date().toISOString(),
                    predictions: item.predictions || [], // Array completo de predicciones
                    fullPrediction: item.fullPrediction || null
                };
            }).filter(item => {
                // Filtrar elementos inv√°lidos
                return item.prediction && item.prediction !== 'undefined' && item.imageUri;
            });
            
            console.log('Historial final:', allHistory.length, 'elementos v√°lidos');
            return allHistory;
        };

        const saveHistory = (history) => {
            localStorage.setItem('prediction_history', JSON.stringify(history));
        };

        const clearHistory = () => {
            const modal = document.getElementById('confirmDeleteModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        };

        const confirmClearHistory = () => {
            // Limpiar ambas fuentes de datos
            localStorage.removeItem('analysis_history');
            localStorage.removeItem('prediction_history');
            console.log('Historial completo eliminado');
            
            // Cerrar modal
            const modal = document.getElementById('confirmDeleteModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            
            // Re-renderizar
            render();
        };

        const cancelClearHistory = () => {
            const modal = document.getElementById('confirmDeleteModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        };

        // Filter functions
        const resetFilters = () => {
            document.getElementById('searchInput').value = '';
            document.getElementById('diseaseFilter').value = '';
            document.getElementById('confidenceFilter').value = '0';
            document.getElementById('sortFilter').value = 'date-desc';
            render();
        };

        // Export and delete functions
        const exportAnalysis = (id) => {
            const history = loadHistory();
            const item = history.find(x => x.id == id);
            if (item) {
                const dataStr = JSON.stringify(item, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `analisis_${item.prediction}_${item.date.replace(/\//g, '-')}.json`;
                link.click();
                URL.revokeObjectURL(url);
            }
        };

        const deleteAnalysis = (id) => {
            if (confirm('¬øEliminar este an√°lisis?')) {
                const history = loadHistory().filter(x => x.id != id);
                saveHistory(history);
                document.getElementById('detailModal').classList.add('hidden');
                document.getElementById('detailModal').classList.remove('flex');
                render();
            }
        };

        // Stats calculation
        const calculateStats = (history) => {
            const total = history.length;
            if (!total) return { total: 0, healthy: 0, diseased: 0, avgConf: 0 };

            const healthy = history.filter(item => {
                const prediction = item.prediction || 'Unknown';
                return prediction.toLowerCase() === 'healthy';
            }).length;
            
            const diseased = total - healthy;
            
            const avgConf = history.reduce((sum, item) => {
                const confidence = typeof item.confidence === 'number' ? item.confidence : 0;
                // Si la confianza est√° en formato decimal (0-1), convertir a porcentaje
                const confPercent = confidence > 1 ? confidence : confidence * 100;
                return sum + confPercent;
            }, 0) / total;
            
            return { total, healthy, diseased, avgConf };
        };

        const renderStats = (history) => {
            const stats = calculateStats(history);
            const healthyPct = stats.total ? ((stats.healthy / stats.total) * 100).toFixed(1) : 0;
            const diseasedPct = stats.total ? ((stats.diseased / stats.total) * 100).toFixed(1) : 0;

            return `
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="bg-white/80 dark:bg-slate-900/80 backdrop-blur-xl rounded-3xl p-6 border border-slate-200/60 dark:border-slate-700/60 shadow-xl shadow-slate-200/50 dark:shadow-slate-900/50 hover:shadow-2xl transition group">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl flex items-center justify-center text-white text-xl">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chart-line-icon lucide-chart-line"><path d="M3 3v16a2 2 0 0 0 2 2h16"/><path d="m19 9-5 5-4-4-3 3"/></svg>
                            </div>
                            <div>
                                <div class="text-slate-600 dark:text-slate-400 text-sm font-medium">Total de Escaneos</div>
                                <div class="text-3xl font-bold text-slate-800 dark:text-white">${stats.total}</div>
                                <div class="text-xs text-slate-500 dark:text-slate-400">registrados</div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white/80 dark:bg-slate-900/80 backdrop-blur-xl rounded-3xl p-6 border border-slate-200/60 dark:border-slate-700/60 shadow-xl shadow-slate-200/50 dark:shadow-slate-900/50 hover:shadow-2xl transition group">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-2xl flex items-center justify-center text-white text-xl">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-heart-plus-icon lucide-heart-plus"><path d="m14.479 19.374-.971.939a2 2 0 0 1-3 .019L5 15c-1.5-1.5-3-3.2-3-5.5a5.5 5.5 0 0 1 9.591-3.676.56.56 0 0 0 .818 0A5.49 5.49 0 0 1 22 9.5a5.2 5.2 0 0 1-.219 1.49"/><path d="M15 15h6"/><path d="M18 12v6"/></svg>
                            </div>
                            <div>
                                <div class="text-slate-600 dark:text-slate-400 text-sm font-medium">Plantas Sanas</div>
                                <div class="text-3xl font-bold text-emerald-600 dark:text-emerald-400">${stats.healthy}</div>
                                <div class="text-xs text-slate-500 dark:text-slate-400">${healthyPct}% del total</div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white/80 dark:bg-slate-900/80 backdrop-blur-xl rounded-3xl p-6 border border-slate-200/60 dark:border-slate-700/60 shadow-xl shadow-slate-200/50 dark:shadow-slate-900/50 hover:shadow-2xl transition group">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-gradient-to-br from-orange-500 to-orange-600 rounded-2xl flex items-center justify-center text-white text-xl">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-activity-icon lucide-activity"><path d="M22 12h-2.48a2 2 0 0 0-1.93 1.46l-2.35 8.36a.25.25 0 0 1-.48 0L9.24 2.18a.25.25 0 0 0-.48 0l-2.35 8.36A2 2 0 0 1 4.49 12H2"/></svg>
                            </div>
                            <div>
                                <div class="text-slate-600 dark:text-slate-400 text-sm font-medium">Con Enfermedades</div>
                                <div class="text-3xl font-bold text-orange-600 dark:text-orange-400">${stats.diseased}</div>
                                <div class="text-xs text-slate-500 dark:text-slate-400">${diseasedPct}% del total</div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white/80 dark:bg-slate-900/80 backdrop-blur-xl rounded-3xl p-6 border border-slate-200/60 dark:border-slate-700/60 shadow-xl shadow-slate-200/50 dark:shadow-slate-900/50 hover:shadow-2xl transition group">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl flex items-center justify-center text-white text-xl">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-shield-check-icon lucide-shield-check"><path d="M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z"/><path d="m9 12 2 2 4-4"/></svg>
                            </div>
                            <div>
                                <div class="text-slate-600 dark:text-slate-400 text-sm font-medium">Confianza Promedio</div>
                                <div class="text-3xl font-bold text-purple-600 dark:text-purple-400">${stats.avgConf.toFixed(1)}%</div>
                                <div class="text-xs text-slate-500 dark:text-slate-400">de precisi√≥n</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderList = (history) => {
            if (!history || !history.length) {
                return `
                    <div class="bg-white/80 dark:bg-slate-900/80 backdrop-blur-xl rounded-3xl p-16 text-center border border-slate-200/60 dark:border-slate-700/60 shadow-xl shadow-slate-200/50 dark:shadow-slate-900/50">
                        <div class="w-32 h-32 bg-slate-100/80 dark:bg-slate-800/80 backdrop-blur-sm rounded-full flex items-center justify-center text-6xl mb-6 mx-auto shadow-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-400 dark:text-slate-500">
                                <path d="M13.4 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-7.4"/><path d="M2 6h4"/><path d="M2 10h4"/><path d="M2 14h4"/><path d="M2 18h4"/><path d="M21.378 5.626a1 1 0 1 0-3.004-3.004l-5.01 5.012a2 2 0 0 0-.506.854l-.837 2.87a.5.5 0 0 0 .62.62l2.87-.837a2 2 0 0 0 .854-.506z"/>
                            </svg>
                        </div>
                        <div class="text-2xl font-bold text-slate-800 dark:text-white mb-3">No hay an√°lisis registrados</div>
                        <div class="text-slate-600 dark:text-slate-400 mb-8 max-w-md mx-auto">Comienza escaneando una planta para ver tu historial de predicciones aqu√≠</div>
                        <a href="/camera" class="inline-flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-emerald-500 to-emerald-600 text-white rounded-2xl shadow-xl shadow-emerald-500/30 hover:shadow-2xl transition font-semibold">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0118.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                            </svg>
                            Realizar primer an√°lisis
                        </a>
                    </div>
                `;
            }

            const items = history.map((item, i) => {
                // Asegurar valores v√°lidos
                const prediction = item.prediction || 'Unknown';
                const confidence = typeof item.confidence === 'number' ? item.confidence : 0;
                const confidencePct = confidence > 1 ? confidence.toFixed(1) : (confidence * 100).toFixed(1);
                const usedTTA = item.usedTTA ? 'TTA' : 'Est√°ndar';
                const imageUri = item.imageUri || '/static/placeholder-image.jpg';
                
                return `
                    <div class="bg-white/80 dark:bg-slate-900/80 backdrop-blur-xl rounded-3xl p-6 shadow-xl shadow-slate-200/50 dark:shadow-slate-900/50 hover:shadow-2xl transition border border-slate-200/60 dark:border-slate-700/60 group cursor-pointer" data-id="${item.id}">
                        <div class="flex items-start gap-6">
                            <!-- Image -->
                            <div class="flex-shrink-0">
                                <img src="${imageUri}" alt="An√°lisis" class="w-20 h-20 rounded-2xl object-cover border-2 border-slate-200 dark:border-slate-700 group-hover:scale-105 transition-transform shadow-lg" onerror="this.src='/static/placeholder-image.jpg'" />
                            </div>
                            
                            <!-- Content -->
                            <div class="flex-1 min-w-0">
                                <div class="flex items-start justify-between mb-3">
                                    <div class="flex items-center gap-3">
                                        <div class="text-2xl">${getDiseaseEmoji(prediction)}</div>
                                        <div>
                                            <h3 class="text-lg font-semibold text-slate-800 dark:text-white">${prediction}</h3>
                                            <div class="flex items-center gap-3 text-sm text-slate-500 dark:text-slate-400">
                                                <span>${item.date || 'Fecha no disponible'}</span>
                                                <span>‚Ä¢</span>
                                                <span>${item.time || 'Hora no disponible'}</span>
                                                <span>‚Ä¢</span>
                                                <span class="px-2 py-1 bg-slate-100/80 dark:bg-slate-800/80 backdrop-blur-sm rounded-full text-xs">${usedTTA}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <button class="openDetail opacity-0 group-hover:opacity-100 transition-opacity w-8 h-8 flex items-center justify-center rounded-xl bg-slate-100/80 dark:bg-slate-800/80 backdrop-blur-sm text-slate-600 dark:text-slate-400 hover:bg-slate-200/80 dark:hover:bg-slate-700/80 shadow-lg" aria-label="Ver detalles">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                        </svg>
                                    </button>
                                </div>
                                
                                <!-- Confidence Bar -->
                                <div class="space-y-2">
                                    <div class="flex items-center justify-between text-sm">
                                        <span class="text-slate-600 dark:text-slate-400">Confianza</span>
                                        <span class="font-semibold text-slate-800 dark:text-slate-200">${confidencePct}%</span>
                                    </div>
                                    <div class="w-full h-2 bg-slate-100 dark:bg-slate-700 rounded-full overflow-hidden shadow-inner">
                                        <div style="width:${confidencePct}%; background:${getDiseaseColor(prediction)}" class="h-full rounded-full transition-all duration-500 shadow-sm"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            return `
                <div class="bg-white/80 dark:bg-slate-900/80 backdrop-blur-xl rounded-3xl border border-slate-200/60 dark:border-slate-700/60 shadow-xl shadow-slate-200/50 dark:shadow-slate-900/50 overflow-hidden">
                    <div class="p-6 border-b border-slate-200 dark:border-slate-700">
                        <div class="flex items-center justify-between">
                            <div>
                                <h2 class="text-xl font-bold text-slate-800 dark:text-white">${history.length} an√°lisis encontrados</h2>
                                <p class="text-slate-600 dark:text-slate-400 text-sm">Haz clic en cualquier an√°lisis para ver m√°s detalles</p>
                            </div>
                            <div class="flex items-center gap-2 text-sm text-slate-500 dark:text-slate-400">
                                <div class="w-2 h-2 bg-emerald-500 rounded-full"></div>
                                <span>Actualizado hace un momento</span>
                            </div>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="space-y-4">${items}</div>
                    </div>
                </div>
            `;
        };

        const openDetailModal = (item) => {
            // Guardar los datos en localStorage y navegar a history_details
            const detailData = {
                imageUri: item.imageUri,
                prediction: item.prediction,
                confidence: item.confidence,
                date: item.date,
                time: item.time,
                usedTTA: item.usedTTA || false,
                processingTime: item.processingTime || null
            };
            
            localStorage.setItem('detail_view_data', JSON.stringify(detailData));
            window.location.href = '/history_details';
        };

        const render = () => {
            // Cargar historial una sola vez
            const allHistory = loadHistory();
            
            // Aplicar filtros sobre los datos cargados
            const filteredHistory = applyFiltersToHistory(allHistory);
            
            // Actualizar containers
            document.getElementById('statsContainer').innerHTML = renderStats(allHistory);
            document.getElementById('listContainer').innerHTML = renderList(filteredHistory);

            // Attach event handlers
            attachEventHandlers();
        };

        // Funci√≥n separada para aplicar filtros
        const applyFiltersToHistory = (history) => {
            const searchTerm = document.getElementById('searchInput')?.value.toLowerCase() || '';
            const diseaseFilter = document.getElementById('diseaseFilter')?.value || '';
            const confidenceFilter = parseFloat(document.getElementById('confidenceFilter')?.value || '0');
            const sortFilter = document.getElementById('sortFilter')?.value || 'date-desc';
            
            let filteredHistory = [...history]; // Crear copia
            
            // Apply filters
            if (searchTerm) {
                filteredHistory = filteredHistory.filter(item => 
                    (item.prediction || '').toLowerCase().includes(searchTerm)
                );
            }
            
            if (diseaseFilter) {
                filteredHistory = filteredHistory.filter(item => item.prediction === diseaseFilter);
            }
            
            if (confidenceFilter > 0) {
                filteredHistory = filteredHistory.filter(item => {
                    const confidence = typeof item.confidence === 'number' ? item.confidence : 0;
                    const confValue = confidence > 1 ? confidence / 100 : confidence; // Normalizar a 0-1
                    return confValue >= confidenceFilter;
                });
            }
            
            // Apply sorting
            filteredHistory.sort((a, b) => {
                switch (sortFilter) {
                    case 'date-asc':
                        return new Date(a.timestamp || a.date) - new Date(b.timestamp || b.date);
                    case 'date-desc':
                        return new Date(b.timestamp || b.date) - new Date(a.timestamp || a.date);
                    case 'confidence-asc':
                        return (a.confidence || 0) - (b.confidence || 0);
                    case 'confidence-desc':
                        return (b.confidence || 0) - (a.confidence || 0);
                    default:
                        return 0;
                }
            });
            
            return filteredHistory;
        };

        const attachEventHandlers = () => {
            // Refresh button
            const refreshBtn = document.getElementById('refreshBtn');
            if (refreshBtn) refreshBtn.onclick = () => render();

            // Clear button
            const clearBtn = document.getElementById('clearBtn');
            if (clearBtn) {
                const history = loadHistory();
                if (history.length === 0) {
                    clearBtn.classList.add('opacity-50', 'pointer-events-none');
                } else {
                    clearBtn.classList.remove('opacity-50', 'pointer-events-none');
                    clearBtn.onclick = clearHistory;
                }
            }

            // Filter inputs
            const filterInputs = ['searchInput', 'diseaseFilter', 'confidenceFilter', 'sortFilter'];
            filterInputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', render);
                    element.addEventListener('input', render);
                }
            });

            // Reset filters button
            const resetFiltersBtn = document.getElementById('resetFilters');
            if (resetFiltersBtn) resetFiltersBtn.onclick = resetFilters;

            // Detail buttons
            document.querySelectorAll('.openDetail').forEach(btn => {
                btn.onclick = (e) => {
                    e.stopPropagation();
                    const card = e.target.closest('[data-id]');
                    const id = card?.getAttribute('data-id');
                    const history = loadHistory();
                    const item = history.find(x => x.id == id);
                    if (item) openDetailModal(item);
                };
            });

            // Card click (full card clickable)
            document.querySelectorAll('[data-id]').forEach(card => {
                card.onclick = (e) => {
                    if (e.target.closest('.openDetail')) return; // Skip if clicking the button
                    const id = card.getAttribute('data-id');
                    const history = loadHistory();
                    const item = history.find(x => x.id == id);
                    if (item) openDetailModal(item);
                };
            });
        };

        // Modal delete confirmation buttons
        document.getElementById('confirmDelete').addEventListener('click', confirmClearHistory);
        document.getElementById('cancelDelete').addEventListener('click', cancelClearHistory);

        // Initial render
        render();
    </script>
{% endblock %}
